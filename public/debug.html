<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIDI Tool - Debug Panel</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
    h1, h2 { color: #333; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; }
    button { background: #4CAF50; color: white; border: none; padding: 10px 15px; 
             border-radius: 4px; cursor: pointer; margin: 5px; }
    button.blue { background: #2196F3; }
    button.red { background: #F44336; }
    .card { border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 20px; }
    .status { padding: 10px; background: #f1f1f1; margin-top: 20px; border-radius: 4px; }
    .log { height: 200px; overflow: auto; background: #f1f1f1; padding: 10px; 
          font-family: monospace; margin-top: 10px; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>MIDI Tool - Debug Panel</h1>
  
  <div class="card">
    <h2>API Test</h2>
    <button id="testApi">Test API Connection</button>
    <button id="testSession" class="blue">Create Test Session</button>
    <button id="testPatterns" class="blue">Test Pattern Generators</button>
    <div id="apiResult"></div>
  </div>
  
  <div class="card">
    <h2>System Info</h2>
    <pre id="systemInfo">Loading...</pre>
  </div>
  
  <div class="card">
    <h2>API Endpoints</h2>
    <button id="listEndpoints">List API Endpoints</button>
    <pre id="endpointList"></pre>
  </div>
  
  <div class="status">Status: Ready</div>
  <div class="log" id="log"></div>
  
  <script>
    // DOM elements
    const apiResult = document.getElementById('apiResult');
    const systemInfo = document.getElementById('systemInfo');
    const endpointList = document.getElementById('endpointList');
    const statusBar = document.querySelector('.status');
    const logElement = document.getElementById('log');
    
    // Buttons
    const testApiBtn = document.getElementById('testApi');
    const testSessionBtn = document.getElementById('testSession');
    const testPatternsBtn = document.getElementById('testPatterns');
    const listEndpointsBtn = document.getElementById('listEndpoints');
    
    // Logging function
    function log(message, type = 'info') {
      console.log(message);
      const entry = document.createElement('div');
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      entry.className = type;
      logElement.appendChild(entry);
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    // Update status
    function updateStatus(message) {
      statusBar.textContent = 'Status: ' + message;
    }
    
    // API helper
    async function callApi(endpoint, method = 'GET', body = null) {
      try {
        const options = {
          method,
          headers: { 'Content-Type': 'application/json' }
        };

        if (body) {
          options.body = JSON.stringify(body);
        }

        log(`API Call: ${method} ${endpoint}`);
        const response = await fetch(`/api${endpoint}`, options);
        
        if (!response.ok) {
          const errorText = await response.text();
          log(`API error (${response.status}): ${errorText}`, 'error');
          return { error: true, status: response.status, message: errorText };
        }
        
        const contentType = response.headers.get('Content-Type');
        if (contentType && contentType.includes('application/json')) {
          const data = await response.json();
          return data;
        } else {
          const text = await response.text();
          return { text };
        }
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        return { error: true, message: error.message };
      }
    }
    
    // Test API connection
    async function testApiConnection() {
      updateStatus('Testing API connection...');
      apiResult.innerHTML = 'Testing...';
      
      // Try the root API endpoint
      const result = await callApi('', 'GET');
      
      if (result.error) {
        apiResult.innerHTML = `<div class="error">API Error: ${result.message}</div>`;
        updateStatus('API test failed');
        return;
      }
      
      apiResult.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
      log('API test successful', 'success');
      updateStatus('API test completed');
    }
    
    // Create test session
    async function createTestSession() {
      updateStatus('Creating test session...');
      apiResult.innerHTML = 'Creating session...';
      
      // Create session
      const sessionResult = await callApi('/sessions', 'POST', {
        name: 'Debug Test Session',
        bpm: 120,
        timeSignature: [4, 4]
      });
      
      if (sessionResult.error) {
        apiResult.innerHTML = `<div class="error">Session creation error: ${sessionResult.message}</div>`;
        updateStatus('Session test failed');
        return;
      }
      
      apiResult.innerHTML = `<h3>Session Created:</h3><pre>${JSON.stringify(sessionResult, null, 2)}</pre>`;
      log(`Created test session with ID: ${sessionResult._id || sessionResult.id}`, 'success');
      updateStatus('Session test completed');
    }
    
    // Test pattern generators
    async function testPatternGenerators() {
      updateStatus('Testing pattern generators...');
      apiResult.innerHTML = 'Testing patterns...';
      
      // Create session first
      const sessionResult = await callApi('/sessions', 'POST', {
        name: 'Pattern Test Session',
        bpm: 120,
        timeSignature: [4, 4]
      });
      
      if (sessionResult.error) {
        apiResult.innerHTML = `<div class="error">Session creation error: ${sessionResult.message}</div>`;
        updateStatus('Pattern test failed');
        return;
      }
      
      const sessionId = sessionResult._id || sessionResult.id;
      log(`Created test session with ID: ${sessionId}`, 'success');
      
      // Test chord pattern
      const chordResult = await callApi('/patterns/chord-progression', 'POST', {
        sessionId,
        key: 'C',
        progressionName: '1-4-5',
        scaleType: 'major',
        octave: 4
      });
      
      // Test bassline
      const bassResult = await callApi('/patterns/bassline', 'POST', {
        sessionId,
        key: 'C',
        progressionName: '1-4-5',
        scaleType: 'major',
        octave: 3
      });
      
      // Test drums
      const drumResult = await callApi('/patterns/drums', 'POST', {
        sessionId,
        patternType: 'basic',
        measures: 2
      });
      
      // Show results
      let resultsHtml = `<h3>Pattern Generator Tests - Session ID: ${sessionId}</h3>`;
      
      resultsHtml += `<h4>Chord Progression:</h4>`;
      resultsHtml += `<pre>${JSON.stringify(chordResult, null, 2)}</pre>`;
      
      resultsHtml += `<h4>Bassline:</h4>`;
      resultsHtml += `<pre>${JSON.stringify(bassResult, null, 2)}</pre>`;
      
      resultsHtml += `<h4>Drum Pattern:</h4>`;
      resultsHtml += `<pre>${JSON.stringify(drumResult, null, 2)}</pre>`;
      
      apiResult.innerHTML = resultsHtml;
      log('Pattern generator tests completed', 'success');
      updateStatus('Pattern tests completed');
    }
    
    // List API endpoints
    async function listApiEndpoints() {
      updateStatus('Fetching API endpoints...');
      endpointList.textContent = 'Loading...';
      
      // This is based on the current structure in our app.js
      const endpoints = [
        { method: 'GET', path: '/api' },
        { method: 'GET', path: '/api/debug' },
        { method: 'GET', path: '/api/sessions' },
        { method: 'POST', path: '/api/sessions' },
        { method: 'GET', path: '/api/sessions/:id' },
        { method: 'PUT', path: '/api/sessions/:id' },
        { method: 'DELETE', path: '/api/sessions/:id' },
        { method: 'GET', path: '/api/music-theory/scales/:root/:type' },
        { method: 'GET', path: '/api/music-theory/chords/:root/:type' },
        { method: 'GET', path: '/api/music-theory/progressions/:key/:mode' },
        { method: 'GET', path: '/api/music-theory/key-signature/:key/:mode' },
        { method: 'POST', path: '/api/music-theory/analyze-chord' },
        { method: 'POST', path: '/api/patterns/chord-progression' },
        { method: 'POST', path: '/api/patterns/bassline' },
        { method: 'POST', path: '/api/patterns/drums' },
        { method: 'DELETE', path: '/api/patterns/notes/:sessionId/:trackId' },
        { method: 'GET', path: '/api/export/midi/:sessionId' },
        { method: 'GET', path: '/api/export/json/:sessionId' },
        { method: 'POST', path: '/api/export/import' }
      ];
      
      let endpointText = 'Available API Endpoints:\n\n';
      endpoints.forEach(endpoint => {
        endpointText += `${endpoint.method}\t${endpoint.path}\n`;
      });
      
      endpointList.textContent = endpointText;
      log('Endpoints listed', 'success');
      updateStatus('Endpoints fetched');
    }
    
    // Get system info
    async function getSystemInfo() {
      // Get browser info
      const browserInfo = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        online: navigator.onlineapplicationCache,
        platform: navigator.platform,
        product: navigator.product,
        audioContextSupported: window.AudioContext || window.webkitAudioContext ? true : false
      };
      
      // Get API info
      const apiInfo = await callApi('/debug', 'GET');
      
      // Combine info
      const info = {
        browser: browserInfo,
        server: apiInfo
      };
      
      // Display info
      systemInfo.textContent = JSON.stringify(info, null, 2);
      log('System info loaded', 'success');
    }
    
    // Event listeners
    testApiBtn.addEventListener('click', testApiConnection);
    testSessionBtn.addEventListener('click', createTestSession);
    testPatternsBtn.addEventListener('click', testPatternGenerators);
    listEndpointsBtn.addEventListener('click', listApiEndpoints);
    
    // Initialize
    updateStatus('Ready');
    log('Debug panel loaded', 'success');
    getSystemInfo();
    listApiEndpoints();
  </script>
</body>
</html>
